{"version":3,"sources":["fist-person-camera.js"],"names":["FirstPersonCamera","cc","_decorator","ccclass","_lbtnDown","_rbtnDown","_keyStates","Array","fill","cameraComponent","node","getComponent","console","error","name","eventManager","setEnabled","mouseListener","EventListener","create","event","MOUSE","onMouseDown","_mouseDownHandler","onMouseMove","_mouseMoveHandler","onMouseUp","_mouseUpHandler","onMouseScroll","_mouseWheelHandler","addListener","keyListener","KEYBOARD","onKeyPressed","_keyDownHandler","onKeyReleased","_keyUpHandler","dt","translationDelta","isKeyPressing","keystr","charCodeAt","_translate","_getForward","_getRight","v3","delta","_scrollY","_button","_mbtnDown","game","canvas","requestPointerLock","document","exitPointerLock","dx","movementX","dy","movementY","_rotateSelfHorizon","_rotateSelfVertical","keycode","length","direction","position","getPosition","vmath","vec3","scaleAndAdd","setPosition","rotation","getRotation","up","quat","rotateAround","setRotation","right","_getDirection","x","y","z","result","transformQuat","Component"],"mappings":"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","sourcesContent":["@cc._decorator.ccclass()\r\nclass FirstPersonCamera extends cc.Component {\r\n\t\r\n\tconstructor() {\r\n\t\tsuper();\r\n\t\t\r\n\t\tthis._lbtnDown = false;\r\n\t\tthis._rbtnDown  = false;\r\n\t\tthis._keyStates = new Array(128);\r\n\t\tthis._keyStates.fill(false);\r\n\t}\r\n\t\r\n\tstart () {\r\n\t\tconst cameraComponent = this.node.getComponent(\"cc.CameraComponent\");\r\n\t\tif (!cameraComponent) {\r\n\t\t\tconsole.error(`Cannot find cc.CameraComponent on node ${this.node.name}`);\r\n\t\t}\r\n\t\t\r\n\t\tcc.eventManager.setEnabled(true);\r\n\t\t\r\n\t\tconst mouseListener = cc.EventListener.create({\r\n\t\t\tevent: cc.EventListener.MOUSE,\r\n\t\t\tonMouseDown: (...args) => this._mouseDownHandler(...args),\r\n\t\t\tonMouseMove: (...args) => this._mouseMoveHandler(...args),\r\n\t\t\tonMouseUp: (...args) => this._mouseUpHandler(...args),\r\n\t\t\tonMouseScroll: (...args) => this._mouseWheelHandler(...args),\r\n\t\t});\r\n\t\tcc.eventManager.addListener(mouseListener, 1);\r\n\t\t\r\n\t\tconst keyListener = cc.EventListener.create({\r\n\t\t\tevent: cc.EventListener.KEYBOARD,\r\n\t\t\tonKeyPressed: (...args) => this._keyDownHandler(...args),\r\n\t\t\tonKeyReleased: (...args) => this._keyUpHandler(...args),\r\n\t\t});\r\n\t\tcc.eventManager.addListener(keyListener, 1);\r\n    }\r\n\t\r\n\tupdate (dt) {\r\n\t\tconst translationDelta = dt * 10;\r\n\t\tconst isKeyPressing = (keystr) => this._keyStates[keystr.charCodeAt(0)];\r\n\t\tif (isKeyPressing(\"W\")) {\r\n\t\t\tthis._translate(this._getForward(), translationDelta);\r\n\t\t}\r\n\t\tif (isKeyPressing(\"S\")) {\r\n\t\t\tthis._translate(this._getForward(), -translationDelta);\r\n\t\t}\r\n\t\tif (isKeyPressing(\"A\")) {\r\n\t\t\tthis._translate(this._getRight(), -translationDelta);\r\n\t\t}\r\n\t\tif (isKeyPressing(\"D\")) {\r\n\t\t\tthis._translate(this._getRight(), translationDelta);\r\n\t\t}\r\n\t\tif (isKeyPressing(\"Q\")) {\r\n\t\t\tthis._translate(cc.v3(0, 1, 0), -translationDelta);\r\n\t\t}\r\n\t\tif (isKeyPressing(\"E\")) {\r\n\t\t\tthis._translate(cc.v3(0, 1, 0), translationDelta);\r\n\t\t}\r\n\t}\r\n\t\r\n\t_mouseWheelHandler(event) {\r\n\t\tconst delta = event._scrollY / 120; // forward to screen is positive\r\n\t\tthis._translate(this._getForward(), delta);\r\n\t}\r\n\t\r\n\t_mouseDownHandler(event) {\r\n\t\tif (event._button === 0) {\r\n\t\t\tthis._lbtnDown = true;\r\n\t\t} else if (event._button === 1) {\r\n\t\t\tthis._mbtnDown = true;\r\n\t\t} else if (event._button === 2) {\r\n        \tcc.game.canvas.requestPointerLock();\r\n\t\t\tthis._rbtnDown = true;\r\n\t\t}\r\n\t}\r\n\t\r\n\t_mouseUpHandler(event) {\r\n\t\tif (event._button === 0) {\r\n\t\t\tthis._lbtnDown = false;\r\n\t\t} else if (event._button === 1) {\r\n\t\t\tthis._mbtnDown = false;\r\n\t\t} else if (event._button === 2) {\r\n        \tdocument.exitPointerLock();\r\n\t\t\tthis._rbtnDown = false;\r\n\t\t}\r\n\t}\r\n\t\r\n\t_mouseMoveHandler(event) {\r\n\t\tconst dx = event.movementX;\r\n\t\tconst dy = -event.movementY;\r\n\t\t\r\n\t\tif (dx !== 0) {\r\n\t\t\tif (this._rbtnDown) {\r\n\t\t\t\tthis._rotateSelfHorizon(dx / 5);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (dy !== 0) {\r\n\t\t\tif (this._rbtnDown) {\r\n\t\t\t\tthis._rotateSelfVertical(dy / 5);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\t_keyDownHandler(keycode) {\r\n\t\tif (keycode < this._keyStates.length) {\r\n\t\t\tthis._keyStates[keycode] = true;\r\n\t\t}\r\n\t}\r\n\t\r\n\t_keyUpHandler(keycode) {\r\n\t\tif (keycode < this._keyStates.length) {\r\n\t\t\tthis._keyStates[keycode] = false;\r\n\t\t}\r\n\t}\r\n\t\r\n\t_translate(direction, delta) {\r\n\t\tconst position = this.node.getPosition();\r\n\t\tcc.vmath.vec3.scaleAndAdd(position, position, direction, delta);\r\n\t\tthis.node.setPosition(position);\r\n\t}\r\n\t\r\n\t_rotateSelfHorizon(delta) {\r\n\t\tconst rotation = this.node.getRotation();\r\n\t\tconst up = cc.v3(0, 1, 0);\r\n\t\t//const up = this._getUp();\r\n\t\tcc.vmath.quat.rotateAround(rotation, rotation, up, -delta/ 360.0 * 3.14159265);\r\n\t\tthis.node.setRotation(rotation);\r\n\t}\r\n\t\r\n\t_rotateSelfVertical(delta) {\r\n\t\tconst rotation = this.node.getRotation();\r\n\t\t//const right = cc.v3(1, 0, 0);\r\n\t\tconst right = this._getRight();\r\n\t\tcc.vmath.quat.rotateAround(rotation, rotation, right, delta / 360.0 * 3.14159265);\r\n\t\tthis.node.setRotation(rotation);\r\n\t}\r\n\t\r\n\t_getForward() {\r\n\t\treturn this._getDirection(0, 0, -1);\r\n\t}\r\n\t\r\n\t_getRight() {\r\n\t\treturn this._getDirection(1, 0, 0);\r\n\t}\r\n\t\r\n\t_getUp() {\r\n\t\treturn this._getDirection(0, 1, 0);\r\n\t}\r\n\t\r\n\t_getDirection(x, y, z) {\r\n\t\tconst result = cc.v3(x, y, z);\r\n\t\tcc.vmath.vec3.transformQuat(result, result, this.node.getRotation());\r\n\t\treturn result;\r\n\t}\r\n}"]}