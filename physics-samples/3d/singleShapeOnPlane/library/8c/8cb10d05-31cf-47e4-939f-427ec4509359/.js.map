{"version":3,"sources":["third-person-camera.js"],"names":["ThirdPersonCamera","cc","_decorator","ccclass","property","Node","Number","_lbtnDown","_rbtnDown","_keyStates","Array","fill","_viewDir","Vec3","vmath","vec3","normalize","_viewVector","eventManager","setEnabled","mouseListener","EventListener","create","event","MOUSE","onMouseDown","_mouseDownHandler","onMouseMove","_mouseMoveHandler","onMouseUp","_mouseUpHandler","onMouseScroll","_mouseWheelHandler","addListener","keyListener","KEYBOARD","onKeyPressed","_keyDownHandler","onKeyReleased","_keyUpHandler","dt","target","scale","distance","targetPosition","getPosition","cameraPosition","add","node","setPosition","lookAt","value","clamp","minDistance","maxDistance","delta","_scrollY","_setDistance","_button","_mbtnDown","game","canvas","requestPointerLock","document","exitPointerLock","dx","movementX","dy","movementY","_rotateSelfHorizon","_rotateSelfVertical","keycode","length","up","v3","_rotate","right","cross","angle","axis","rotation","quat","rotateAround","transformQuat","_getDirection","x","y","z","result","getRotation","Component"],"mappings":"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","sourcesContent":["@cc._decorator.ccclass()\r\nclass ThirdPersonCamera extends cc.Component {\r\n    @cc._decorator.property(cc.Node)\r\n    target = null;\r\n\r\n    @cc._decorator.property(Number)\r\n    distance = 100;\r\n\r\n    @cc._decorator.property(Number)\r\n    minDistance = 10;\r\n\r\n    @cc._decorator.property(Number)\r\n    maxDistance = 200;\r\n\t\r\n\tconstructor() {\r\n\t\tsuper();\r\n\t\t\r\n\t\tthis._lbtnDown = false;\r\n\t\tthis._rbtnDown  = false;\r\n\t\tthis._keyStates = new Array(128);\r\n        this._keyStates.fill(false);\r\n        \r\n        this._viewDir = new cc.Vec3(1, 1, 1);\r\n        cc.vmath.vec3.normalize(this._viewDir, this._viewDir);\r\n\r\n        this._viewVector = new cc.Vec3(0, 0, 0);\r\n\t}\r\n\t\r\n\tstart () {\r\n\t\tcc.eventManager.setEnabled(true);\r\n\t\t\r\n\t\tconst mouseListener = cc.EventListener.create({\r\n\t\t\tevent: cc.EventListener.MOUSE,\r\n\t\t\tonMouseDown: (...args) => this._mouseDownHandler(...args),\r\n\t\t\tonMouseMove: (...args) => this._mouseMoveHandler(...args),\r\n\t\t\tonMouseUp: (...args) => this._mouseUpHandler(...args),\r\n\t\t\tonMouseScroll: (...args) => this._mouseWheelHandler(...args),\r\n\t\t});\r\n\t\tcc.eventManager.addListener(mouseListener, 1);\r\n\t\t\r\n\t\tconst keyListener = cc.EventListener.create({\r\n\t\t\tevent: cc.EventListener.KEYBOARD,\r\n\t\t\tonKeyPressed: (...args) => this._keyDownHandler(...args),\r\n\t\t\tonKeyReleased: (...args) => this._keyUpHandler(...args),\r\n\t\t});\r\n\t\tcc.eventManager.addListener(keyListener, 1);\r\n    }\r\n\t\r\n\tupdate (dt) {\r\n        if (!this.target) {\r\n            return;\r\n        }\r\n        \r\n        cc.vmath.vec3.scale(this._viewVector, this._viewDir, this.distance);\r\n\r\n        const targetPosition = this.target.getPosition();\r\n\r\n        const cameraPosition = new cc.Vec3();\r\n        cc.vmath.vec3.add(cameraPosition, targetPosition, this._viewVector);\r\n        this.node.setPosition(cameraPosition);\r\n        this.node.lookAt(targetPosition);\r\n    }\r\n    \r\n    _setDistance(value) {\r\n        this.distance = cc.vmath.clamp(value, this.minDistance, this.maxDistance);\r\n    }\r\n\t\r\n\t_mouseWheelHandler(event) {\r\n        const delta = event._scrollY / 120; // forward to screen is positive\r\n        this._setDistance(this.distance - delta);\r\n\t}\r\n\t\r\n\t_mouseDownHandler(event) {\r\n\t\tif (event._button === 0) {\r\n\t\t\tthis._lbtnDown = true;\r\n\t\t} else if (event._button === 1) {\r\n\t\t\tthis._mbtnDown = true;\r\n\t\t} else if (event._button === 2) {\r\n        \tcc.game.canvas.requestPointerLock();\r\n\t\t\tthis._rbtnDown = true;\r\n\t\t}\r\n\t}\r\n\t\r\n\t_mouseUpHandler(event) {\r\n\t\tif (event._button === 0) {\r\n\t\t\tthis._lbtnDown = false;\r\n\t\t} else if (event._button === 1) {\r\n\t\t\tthis._mbtnDown = false;\r\n\t\t} else if (event._button === 2) {\r\n        \tdocument.exitPointerLock();\r\n\t\t\tthis._rbtnDown = false;\r\n\t\t}\r\n\t}\r\n\t\r\n\t_mouseMoveHandler(event) {\r\n\t\tconst dx = event.movementX;\r\n\t\tconst dy = -event.movementY;\r\n\t\t\r\n\t\tif (dx !== 0) {\r\n\t\t\tif (this._lbtnDown) {\r\n\t\t\t\tthis._rotateSelfHorizon(dx / 5);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (dy !== 0) {\r\n\t\t\tif (this._rbtnDown) {\r\n\t\t\t\tthis._rotateSelfVertical(dy / 5);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\t_keyDownHandler(keycode) {\r\n\t\tif (keycode < this._keyStates.length) {\r\n\t\t\tthis._keyStates[keycode] = true;\r\n\t\t}\r\n\t}\r\n\t\r\n\t_keyUpHandler(keycode) {\r\n\t\tif (keycode < this._keyStates.length) {\r\n\t\t\tthis._keyStates[keycode] = false;\r\n\t\t}\r\n\t}\r\n\t\r\n\t_rotateSelfHorizon(delta) {\r\n\t\tconst up = cc.v3(0, 1, 0);\r\n        this._rotate(-delta/ 360.0 * 3.14159265, up);\r\n\t}\r\n\t\r\n\t_rotateSelfVertical(delta) {\r\n        const up = cc.v3(0, 1, 0);\r\n        const right = new cc.Vec3();\r\n        cc.vmath.vec3.cross(right, this._viewDir, up);\r\n        cc.vmath.vec3.normalize(right, right);\r\n        this._rotate(-delta/ 360.0 * 3.14159265, right);\r\n    }\r\n    \r\n    _rotate(angle, axis) {\r\n        const rotation = cc.vmath.quat.create();\r\n        cc.vmath.quat.rotateAround(rotation, rotation, axis, angle);\r\n        cc.vmath.vec3.transformQuat(this._viewDir, this._viewDir, rotation);\r\n    }\r\n\t\r\n\t_getForward() {\r\n\t\treturn this._getDirection(0, 0, -1);\r\n\t}\r\n\t\r\n\t_getRight() {\r\n\t\treturn this._getDirection(1, 0, 0);\r\n\t}\r\n\t\r\n\t_getUp() {\r\n\t\treturn this._getDirection(0, 1, 0);\r\n\t}\r\n\t\r\n\t_getDirection(x, y, z) {\r\n\t\tconst result = cc.v3(x, y, z);\r\n\t\tcc.vmath.vec3.transformQuat(result, result, this.node.getRotation());\r\n\t\treturn result;\r\n\t}\r\n}"]}